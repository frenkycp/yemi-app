<?php
// This class was automatically generated by a giiant build task
// You should not change it manually as it will be overwritten on next build

namespace app\controllers;

use yii\web\Controller;
use app\models\UncountableView02;
use dmstr\bootstrap\Tabs;
use yii\helpers\Url;

/**
 * 
 */
class PartsUncountableMonthlyReportController extends Controller
{
	public function actionIndex()
	{
		$data = [];

		$get_data_arr = UncountableView02::find()
		//->where(['>=', 'PERIOD', '201808'])
		->orderBy('ITEM, POST_DATE')
		->all();

		$min_max_post_date = UncountableView02::find()
		->select([
			'MIN_DATE' => 'MIN(POST_DATE)',
			'MAX_DATE' => 'MAX(POST_DATE)',
		])
		->one();

		$item_arr = UncountableView02::find()->select('DISTINCT(ITEM)')->all();

		$item_desc_arr = [
			'Q825YL07000' => 'CLEARSHOT LIQUID FOR FUSION GUN',
			'WT92881' => 'LINE-X ISOCYANATE SE-210 : BLACK',
			'WU27851' => 'LINE-X RESIN SE-BK210 : BLACK',
			'WY69990' => 'MDF T15 4X8 HUME CARB P2',
		];

		$tmp_purch_limit = [
			'201803' => [
				3000, 5000
			],
			'201804' => [
				4000, 6000
			],
			'201805' => [
				3000, 5000
			],
			'201806' => [
				4000, 6000
			],
			'201807' => [
				3000, 5000
			],
			'201808' => [
				4000, 6000
			],
			'201809' => [
				3000, 5000
			],
		];

		$panel_class = 'info';

		/*$date_from = strtotime($min_max_post_date->MIN_DATE);
		$date_to = strtotime($min_max_post_date->MAX_DATE);

		foreach ($item_arr as $key => $item) {
			for ($i = $date_from; $i <= $date_to; $i += 86400) { 
				foreach ($get_data_arr as $key => $value) {
					$partno = $value->ITEM;
					if ($partno == $item) {
						# code...
					}
				}
			}
		}*/
		

		foreach ($get_data_arr as $key => $value) {
			if ($last_update === null) {
				$last_update = $value->UPLOAD_DATE;
			}
			$partno = $value->ITEM;
			$post_date = (strtotime("$value->POST_DATE +3 hours") * 1000);
			//$post_date = $value->POST_DATE;
			$ending_qty = $value->ENDING_QTY;
			$wh_ending_qty = $value->WH_ENDING_QTY;
			$deviasi = $value->DEVIASI_PERCENT;

			if (!isset($data[$partno]['min_deviasi'])) {
				$data[$partno]['min_deviasi'] = $deviasi;
			} else {
				if ($deviasi < $data[$partno]['min_deviasi']) {
					$data[$partno]['min_deviasi'] = $deviasi;
				}
			}

			if (!isset($data[$partno]['max_deviasi'])) {
				$data[$partno]['max_deviasi'] = $deviasi;
			} else {
				if ($deviasi > $data[$partno]['max_deviasi']) {
					$data[$partno]['max_deviasi'] = $deviasi;
				}
			}

			$deviasi_color = 'rgba(0, 255, 0, 0.9)';
			if ($value->DEVIASI_PERCENT >= 30) {
				$deviasi_color = 'rgba(255, 0, 0, 0.9)';
			}

			if ($wh_ending_qty < 5000) {
				//$panel_class = 'danger';
			} elseif ($wh_ending_qty < 10000) {
				//$panel_class = 'warning';
			}

			if (!isset($data[$partno]['item_desc'])) {
				$data[$partno]['item_desc'] = $value->ITEM_DESC;
			}

			if (!isset($data[$partno]['uom'])) {
				$data[$partno]['uom'] = $value->UOM;
			}

			$data[$partno]['panel_class'] = $panel_class;

			$data[$partno]['categories'][] = $post_date;
			$data[$partno]['data1'][] = [
				$post_date,
				(int)$ending_qty
			];
			$data[$partno]['data2'][] = [
				$post_date,
				(int)$wh_ending_qty
			];
			$data[$partno]['deviasi'][] = [
				'x' => $post_date,
				'y' => (float)$deviasi,
				'color' => $deviasi_color
			];
			$data[$partno]['danger_area'][] = [
				'x' => $post_date,
				'y' => $tmp_purch_limit[$value->PERIOD][0]
			];
			$data[$partno]['warning_area'][] = [
				'x' => $post_date,
				'y' => $tmp_purch_limit[$value->PERIOD][1]
			];
		}

		return $this->render('index', [
			'data' => $data,
			'last_update' => $last_update
		]);
	}
}